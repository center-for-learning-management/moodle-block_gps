define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","block_gps/modal_reachedlocation","block_gps/leaflet"],function(g,c,d,e,b,a,f){return{debug:false,honeypots:[],honeypotmodal:undefined,honeypotshown:[],lasttrackedposition:{altitude:0,latitude:0,longitude:0},locateinterval:null,locateintervalrunning:false,deg2rad:function(h){return h*(Math.PI/180)},distance:function(j,h,i){if(typeof(i)==="undefined"){i=0}var n=this.deg2rad(j.latitude);var l=this.deg2rad(j.longitude);var m=this.deg2rad(h.latitude);var k=this.deg2rad(h.longitude);latDelta=m-n;lonDelta=k-l;angle=2*Math.asin(Math.sqrt(Math.pow(Math.sin(latDelta/2),2)+Math.cos(n)*Math.cos(m)*Math.pow(Math.sin(lonDelta/2),2)));return Math.round(angle*6378.388*1000,i)},interval:function(i){var h=this;if(this.debug){console.log("block_gps/geoassist::interval(ms)",i)}if(i>0){g("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-off").addClass("fa-toggle-on");clearInterval(this.locateinterval);this.locateinterval=setInterval(function(){h.locate()},i);this.locateintervalrunning=true;navigator.geolocation.getCurrentPosition(function(){})}else{if(typeof(this.locateinterval)!=="undefined"){g("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-on").addClass("fa-toggle-off");clearInterval(this.locateinterval);this.locateinterval=null;this.locateintervalrunning=false}}c.call([{methodname:"block_gps_setinterval",args:{ms:i},done:function(j){},fail:d.exception,}])},intervalToggle:function(){if(this.debug){console.log("block_gps/geoassist::intervalToggle()")}if(this.locateintervalrunning){this.interval(0)}else{this.interval(5000)}},locateInit:function(h,j,i){if(this.debug){console.log("block_gps/geoassist::locateInit(altitude, latitude, longitude)",h,j,i)}if(typeof(h)!=="undefined"){this.lasttrackedposition.altitude=h}if(typeof(j)!=="undefined"){this.lasttrackedposition.latitude=j}if(typeof(i)!=="undefined"){this.lasttrackedposition.longitude=i}},locate:function(i){if(typeof(i)==="undefined"){i=false}if(this.debug){console.log("block_gps/geoassist::locate(once)",i)}var h=this;if(navigator.geolocation){if(h.debug){console.log("navigator.geolocation exists")}navigator.geolocation.getCurrentPosition(function(j){j=j.coords;if(h.debug){console.log("retrieved position",j)}g(".availability_gps_condition_button").each(function(){var m=this;var n=g(m).find(".latitude").html();var o=g(m).find(".longitude").html();var l={latitude:n,longitude:o};var p=h.distance(j,l);if(h.debug){console.log("Update UI Position of ",l," with distance ",p," in span ",m)}e.get_strings([{key:"meters",component:"block_gps"},{key:"kilometers",component:"block_gps"},]).done(function(q){g(m).find(".distanceerror").addClass("hidden");g(m).find(".distanceok").removeClass("hidden");if(p>1000){g(m).find(".distance").html(Math.round(p/1000,1));g(m).find(".distancelabel").html(q[1])}else{g(m).find(".distance").html(p);g(m).find(".distancelabel").html(q[0])}}).fail(d.exception)});h.honeypots.forEach(function(l){var o=h.distance(j,l);if(h.debug){console.log("Our distance to honeypot ",l," is ",o)}if(o<l.accuracy){if(h.debug){console.log("JEHAAA, you reached it!")}if(l.persistent>0){if(h.debug){console.log("This achievement is stored persistently, let us tell Moodle about it!")}var m={lat:j.latitude,lon:j.longitude,alt:j.altitude};c.call([{methodname:"block_gps_locate",args:m,done:function(p){if(h.debug){console.log("moodle informed about position",m," replied with",p)}if(p=="coordinates_set"){if(h.debug){console.log("Reloading page")}}},fail:d.exception,}])}var n=false;h.honeypotshown.forEach(function(p){if(p==l.url){n=true}});if(!n){h.honeypotshown.push(l.url);if(h.debug){console.log("Now showing a success modal!")}if(typeof(h.honeypotmodal)==="undefined"){a.create({type:f.TYPE,}).then(function(p){h.honeypotmodal=p;g(h.honeypotmodal.getRoot()).find('.modal-footer a[data-action="goto"]').attr("href",l.url);g(h.honeypotmodal.getRoot()).find(".modal-body span.name").html('"'+l.name+'"');p.show()})}else{g(h.honeypotmodal.getRoot()).find('.modal-footer a[data-action="goto"]').attr("href",l.url);g(h.honeypotmodal.getRoot()).find(".modal-body span.name").html('"'+l.name+'"');h.honeypotmodal.show()}}else{if(h.debug){console.log("Our last modal was for this honeypot - suppress!")}}}});var k=h.distance(h.lasttrackedposition,j);if(h.debug){console.log("distance since last tracked position",k)}if(i&&k<5){e.get_strings([{key:"location_not_changed:title",component:"block_gps"},{key:"location_not_changed:body",component:"block_gps"},]).done(function(l){a.create({type:a.types.OK,title:l[0],body:l[1],}).then(function(m){m.show();setTimeout(function(){m.hide()},2000)})}).fail(d.exception)}h.lasttrackedposition=j})}else{alert("geolocation_not_supported")}},pushHoneypot:function(h){if(this.debug){console.log("block_gps/geoassist::pushHoneypot(location)",h)}this.honeypots.push(h)},}});