define(["jquery","core/ajax","core/notification","core/str","core/url","block_gps/leaflet"],function(c,b,d,e,a){return{lasttrackedposition:{altitude:0,latitude:0,longitude:0},locateinterval:null,locate:function(f,i,h){if(typeof(f)!=="undefined"){this.lasttrackedposition.altitude=f}if(typeof(i)!=="undefined"){this.lasttrackedposition.latitude=i}if(typeof(h)!=="undefined"){this.lasttrackedposition.longitude=h}console.log("initialized with lasttrackedposition ",this.lasttrackedposition);var g=this;if(typeof(this.locateinterval)!=="undefined"){if(navigator.geolocation){this.locateinterval=setInterval(function(){navigator.geolocation.getCurrentPosition(function(j){j=j.coords;var k=g.distance(g.lasttrackedposition,j);if(k>5){b.call([{methodname:"block_gps_locate",args:{lat:j.latitude,lon:j.longitude,alt:j.altitude},done:function(l){g.lasttrackedposition=j;if(l=="coordinates_set"){top.location.href=top.location.href}else{if(l=="moved_less_than_5m"){}else{}}},fail:d.exception,}])}})},5000)}else{alert("geolocation_not_supported")}}},current:function(g){var f=this;if(navigator.geolocation){M.availability_gps.locatebtn=g;M.availability_gps.locatebtn.value=M.str.availability_gps.loading+"...";navigator.geolocation.getCurrentPosition(function(h){M.availability_gps.locatebtn.value=M.str.availability_gps.current_location;f.coord(h.coords.latitude,h.coords.longitude)})}else{M.availability_gps.locatebtn.value=M.str.availability_gps.geolocation_not_supported}},deg2rad:function(f){return f*(Math.PI/180)},distance:function(h,f,g){if(typeof(g)==="undefined"){g=0}var l=this.deg2rad(h.latitude);var j=this.deg2rad(h.longitude);var k=this.deg2rad(f.latitude);var i=this.deg2rad(f.longitude);latDelta=k-l;lonDelta=i-j;angle=2*Math.asin(Math.sqrt(Math.pow(Math.sin(latDelta/2),2)+Math.cos(l)*Math.cos(k)*Math.pow(Math.sin(lonDelta/2),2)));return Math.round(angle*6378.388*1000,g)},init:function(f){var g=this;var k=c("[name=latitude]").val();var l=c("[name=longitude]").val();var j=c("[name=accuracy]").val();if(typeof(f)!=="undefined"){c("#availability_gps_map").toggleClass("hidden");if(k==0&&l==0&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(m){g.coord(m.coords.latitude,m.coords.longitude)})}}if(typeof M.availability_gps.marker!=="undefined"){M.availability_gps.marker.setLatLng(L.latLng(k,l));M.availability_gps.map.panTo(L.latLng(k,l));M.availability_gps.circle.setLatLng(L.latLng(k,l));M.availability_gps.circle.setRadius(j)}else{M.availability_gps.map=L.map("availability_gps_map",{center:[k,l],zoom:13});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(M.availability_gps.map);var i=""+a.relativeUrl("/blocks/gps/pix/google-maps-pin-blue.svg");var h=L.icon({iconUrl:i,iconRetinaUrl:i,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});M.availability_gps.marker=L.marker([k,l],{title:"",draggable:true,icon:h}).addTo(M.availability_gps.map).on("dragend",function(){var m=M.availability_gps.marker.getLatLng();g.coord(m.lat,m.lng)}).on("move",function(){var m=M.availability_gps.marker.getLatLng();M.availability_gps.circle.setLatLng(m)});M.availability_gps.circle=L.circle([k,l],{color:"red",fillColor:"#f03",fillOpacity:0.2,radius:j,}).addTo(M.availability_gps.map)}},initIfShown:function(){console.log("initifshown");if(typeof M.availability_gps.marker!=="undefined"){console.log("is shown");this.init()}},coord:function(f,g){M.availability_gps.node.one("[name=longitude]").set("value",g);M.availability_gps.node.one("[name=latitude]").set("value",f);M.core_availability.form.update();this.init()}}});