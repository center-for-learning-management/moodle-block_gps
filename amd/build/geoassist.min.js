define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","block_gps/leaflet"],function(f,c,d,e,b,a){return{debug:true,lasttrackedposition:{altitude:0,latitude:0,longitude:0},locateinterval:null,locateintervalrunning:false,interval:function(h){var g=this;if(this.debug){console.log("block_gps/geoassist::interval(ms)",h)}if(h>0){f("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-off").addClass("fa-toggle-on");clearInterval(this.locateinterval);this.locateinterval=setInterval(function(){g.locate()},h);this.locateintervalrunning=true}else{if(typeof(this.locateinterval)!=="undefined"){f("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-on").addClass("fa-toggle-off");clearInterval(this.locateinterval);this.locateinterval=null;this.locateintervalrunning=false}}c.call([{methodname:"block_gps_setinterval",args:{ms:h},done:function(i){},fail:d.exception,}])},intervalToggle:function(){if(this.debug){console.log("block_gps/geoassist::intervalToggle()")}if(this.locateintervalrunning){this.interval(0)}else{this.interval(5000)}},locateInit:function(g,i,h){if(this.debug){console.log("block_gps/geoassist::locateInit(altitude, latitude, longitude)",g,i,h)}if(typeof(g)!=="undefined"){this.lasttrackedposition.altitude=g}if(typeof(i)!=="undefined"){this.lasttrackedposition.latitude=i}if(typeof(h)!=="undefined"){this.lasttrackedposition.longitude=h}},locate:function(h){if(this.debug){console.log("block_gps/geoassist::locate()")}var g=this;if(navigator.geolocation){if(g.debug){console.log("navigator.geolocation exists")}navigator.geolocation.getCurrentPosition(function(i){i=i.coords;if(g.debug){console.log("retrieved position",i)}var k=g.distance(g.lasttrackedposition,i);if(g.debug){console.log("distance since last tracked position",k)}if(k>5){var j={lat:i.latitude,lon:i.longitude,alt:i.altitude};c.call([{methodname:"block_gps_locate",args:j,done:function(l){if(g.debug){console.log("moodle informed about position",j," replied with",l)}g.lasttrackedposition=i;if(l=="coordinates_set"){if(g.debug){console.log("Reloading page")}location.reload()}},fail:d.exception,}])}else{if(typeof(h)!=="undefined"&&h){e.get_strings([{key:"location_not_changed:title",component:"block_gps"},{key:"location_not_changed:body",component:"block_gps"},]).done(function(l){a.create({type:a.types.OK,title:l[0],body:l[1],}).then(function(m){m.show();setTimeout(function(){m.hide()},2000)})}).fail(d.exception)}}})}else{alert("geolocation_not_supported")}},current:function(h){var g=this;if(navigator.geolocation){M.availability_gps.locatebtn=h;M.availability_gps.locatebtn.value=M.str.availability_gps.loading+"...";navigator.geolocation.getCurrentPosition(function(i){M.availability_gps.locatebtn.value=M.str.availability_gps.current_location;g.coord(i.coords.latitude,i.coords.longitude)})}else{M.availability_gps.locatebtn.value=M.str.availability_gps.geolocation_not_supported}},deg2rad:function(g){return g*(Math.PI/180)},distance:function(i,g,h){if(typeof(h)==="undefined"){h=0}var m=this.deg2rad(i.latitude);var k=this.deg2rad(i.longitude);var l=this.deg2rad(g.latitude);var j=this.deg2rad(g.longitude);latDelta=l-m;lonDelta=j-k;angle=2*Math.asin(Math.sqrt(Math.pow(Math.sin(latDelta/2),2)+Math.cos(m)*Math.cos(l)*Math.pow(Math.sin(lonDelta/2),2)));return Math.round(angle*6378.388*1000,h)},init:function(g){var h=this;var l=f("[name=latitude]").val();var m=f("[name=longitude]").val();var k=f("[name=accuracy]").val();if(typeof(g)!=="undefined"){f("#availability_gps_map").toggleClass("hidden");if(l==0&&m==0&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(n){h.coord(n.coords.latitude,n.coords.longitude)})}}if(typeof M.availability_gps.marker!=="undefined"){M.availability_gps.marker.setLatLng(L.latLng(l,m));M.availability_gps.map.panTo(L.latLng(l,m));M.availability_gps.circle.setLatLng(L.latLng(l,m));M.availability_gps.circle.setRadius(k)}else{M.availability_gps.map=L.map("availability_gps_map",{center:[l,m],zoom:13});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(M.availability_gps.map);var j=""+b.relativeUrl("/blocks/gps/pix/google-maps-pin-blue.svg");var i=L.icon({iconUrl:j,iconRetinaUrl:j,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});M.availability_gps.marker=L.marker([l,m],{title:"",draggable:true,icon:i}).addTo(M.availability_gps.map).on("dragend",function(){var n=M.availability_gps.marker.getLatLng();h.coord(n.lat,n.lng)}).on("move",function(){var n=M.availability_gps.marker.getLatLng();M.availability_gps.circle.setLatLng(n)});M.availability_gps.circle=L.circle([l,m],{color:"red",fillColor:"#f03",fillOpacity:0.2,radius:k,}).addTo(M.availability_gps.map)}},initIfShown:function(){console.log("initifshown");if(typeof M.availability_gps.marker!=="undefined"){console.log("is shown");this.init()}},coord:function(g,h){M.availability_gps.node.one("[name=longitude]").set("value",h);M.availability_gps.node.one("[name=latitude]").set("value",g);M.core_availability.form.update();this.init()}}});