define(["jquery","core/ajax","core/notification","core/str","core/url","block_gps/leaflet"],function(a,b,c,d,e){return{locate:function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){console.log("Sending position",e),b.call([{methodname:"block_gps_locate",args:{lat:e.coords.latitude,lon:e.coords.longitude,alt:e.coords.altitude},done:function(b){if(console.log("Result",b),"coordinates_set"==b)top.location.href=top.location.href;else{var e=d.get_string(b,"block_gps");a.when(e).done(function(a){c.alert(a,"")})}},fail:c.exception}])}):alert("geolocation_not_supported")},map:void 0,marker:void 0,current:function(){navigator.geolocation?(M.availability_gps.locatebtn=this,M.availability_gps.locatebtn.value=M.str.availability_gps.loading+"...",navigator.geolocation.getCurrentPosition(function(a){M.availability_gps.locatebtn.value=M.str.availability_gps.current_location,console.log("Position:",a.coords),this.coord(a.coords.latitude,a.coords.longitude)})):M.availability_gps.locatebtn.value=M.str.availability_gps.geolocation_not_supported},init:function(a,b){if("undefined"!=typeof this.marker)this.marker.setLatLng(L.latLng(a,b)),this.map.panTo(L.latLng(a,b));else{Y.one("#availability_gps_map").removeClass("closed"),Y.one("#availability_gps_map_info").removeClass("closed"),this.map=L.map("availability_gps_map",{center:[a,b],zoom:13}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(this.map);var c=""+e.relativeUrl("/blocks/gps/pix/google-maps-pin-blue.svg"),d=L.icon({iconUrl:c,iconRetinaUrl:c,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});this.marker=L.marker([a,b],{title:"",draggable:!0,icon:d}).addTo(this.map).on("dragend",function(){var a=this.marker.getLatLng();this.coord(a.lat,a.lng)})}},coord:function(a,b){this.init(a,b),M.availability_gps.node.one("[name=longitude]").set("value",b),M.availability_gps.node.one("[name=latitude]").set("value",a),M.core_availability.form.update()}}});