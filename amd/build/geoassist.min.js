define(["jquery","core/ajax","core/notification","core/str","core/url","block_gps/leaflet"],function(c,b,d,e,a){return{locateinterval:null,locate:function(){if(typeof(this.locateinterval)!=="undefined"){if(navigator.geolocation){this.locateinterval=setInterval(function(){navigator.geolocation.getCurrentPosition(function(f){b.call([{methodname:"block_gps_locate",args:{lat:f.coords.latitude,lon:f.coords.longitude,alt:f.coords.altitude},done:function(g){if(g=="coordinates_set"){console.log("User moved more than 5m since last position, reloading page");top.location.href=top.location.href}else{if(g=="moved_less_than_5m"){console.log("User moved less than 5m since last position")}else{console.log("There was an error")}}},fail:d.exception,}])})},5000)}else{alert("geolocation_not_supported")}}},current:function(g){var f=this;if(navigator.geolocation){M.availability_gps.locatebtn=g;M.availability_gps.locatebtn.value=M.str.availability_gps.loading+"...";navigator.geolocation.getCurrentPosition(function(h){M.availability_gps.locatebtn.value=M.str.availability_gps.current_location;f.coord(h.coords.latitude,h.coords.longitude)})}else{M.availability_gps.locatebtn.value=M.str.availability_gps.geolocation_not_supported}},init:function(f){var g=this;var k=c("[name=latitude]").val();var l=c("[name=longitude]").val();var j=c("[name=accuracy]").val();if(typeof(f)!=="undefined"){c("#availability_gps_map").toggleClass("hidden");if(k==0&&l==0&&navigator.geolocation){navigator.geolocation.getCurrentPosition(function(m){g.coord(m.coords.latitude,m.coords.longitude)})}}if(typeof M.availability_gps.marker!=="undefined"){M.availability_gps.marker.setLatLng(L.latLng(k,l));M.availability_gps.map.panTo(L.latLng(k,l));M.availability_gps.circle.setLatLng(L.latLng(k,l));M.availability_gps.circle.setRadius(j)}else{M.availability_gps.map=L.map("availability_gps_map",{center:[k,l],zoom:13});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:["a","b","c"]}).addTo(M.availability_gps.map);var i=""+a.relativeUrl("/blocks/gps/pix/google-maps-pin-blue.svg");var h=L.icon({iconUrl:i,iconRetinaUrl:i,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});M.availability_gps.marker=L.marker([k,l],{title:"",draggable:true,icon:h}).addTo(M.availability_gps.map).on("dragend",function(){var m=M.availability_gps.marker.getLatLng();g.coord(m.lat,m.lng)}).on("move",function(){var m=M.availability_gps.marker.getLatLng();M.availability_gps.circle.setLatLng(m)});M.availability_gps.circle=L.circle([k,l],{color:"red",fillColor:"#f03",fillOpacity:0.2,radius:j,}).addTo(M.availability_gps.map)}},initIfShown:function(){console.log("initifshown");if(typeof M.availability_gps.marker!=="undefined"){console.log("is shown");this.init()}},coord:function(f,g){M.availability_gps.node.one("[name=longitude]").set("value",g);M.availability_gps.node.one("[name=latitude]").set("value",f);M.core_availability.form.update();this.init()}}});