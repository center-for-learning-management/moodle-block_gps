define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","block_gps/modal_reachedlocation","block_gps/leaflet"],function(g,c,d,e,b,a,f){return{debug:false,honeypots:[],honeypotmodal:undefined,honeypotshown:[],lasttrackedposition:{altitude:0,latitude:0,longitude:0},locateinterval:null,locateintervalrunning:false,deg2rad:function(h){return h*(Math.PI/180)},distance:function(j,h,i){if(typeof(i)==="undefined"){i=0}var n=this.deg2rad(j.latitude);var l=this.deg2rad(j.longitude);var m=this.deg2rad(h.latitude);var k=this.deg2rad(h.longitude);latDelta=m-n;lonDelta=k-l;angle=2*Math.asin(Math.sqrt(Math.pow(Math.sin(latDelta/2),2)+Math.cos(n)*Math.cos(m)*Math.pow(Math.sin(lonDelta/2),2)));return Math.round(angle*6378.388*1000,i)},interval:function(i){var h=this;if(this.debug){console.log("block_gps/geoassist::interval(ms)",i)}if(i>0){g("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-off").addClass("fa-toggle-on");clearInterval(this.locateinterval);this.locateinterval=setInterval(function(){h.locate()},i);this.locateintervalrunning=true;navigator.geolocation.getCurrentPosition(function(){})}else{if(typeof(this.locateinterval)!=="undefined"){g("#block_gps_interval_toggler").find("i.fa").removeClass("fa-toggle-on").addClass("fa-toggle-off");clearInterval(this.locateinterval);this.locateinterval=null;this.locateintervalrunning=false}}c.call([{methodname:"block_gps_setinterval",args:{ms:i},done:function(j){},fail:d.exception,}])},intervalToggle:function(){if(this.debug){console.log("block_gps/geoassist::intervalToggle()")}if(this.locateintervalrunning){this.interval(0)}else{this.interval(5000)}},locateInit:function(h,j,i){if(this.debug){console.log("block_gps/geoassist::locateInit(altitude, latitude, longitude)",h,j,i)}if(typeof(h)!=="undefined"){this.lasttrackedposition.altitude=h}if(typeof(j)!=="undefined"){this.lasttrackedposition.latitude=j}if(typeof(i)!=="undefined"){this.lasttrackedposition.longitude=i}},locate:function(i){if(typeof(i)==="undefined"){i=false}if(this.debug){console.log("block_gps/geoassist::locate(once)",i)}var h=this;if(navigator.geolocation){if(h.debug){console.log("navigator.geolocation exists")}navigator.geolocation.getCurrentPosition(function(j){j=j.coords;if(typeof(j.latitude)!=="undefined"&&j.latitude!=null){g(".block_gps_current_latitude").html(j.latitude)}if(typeof(j.longitude)!=="undefined"&&j.longitude!=null){g(".block_gps_current_longitude").html(j.longitude)}if(typeof(j.altitude)!=="undefined"&&j.altitude!=null){g(".block_gps_current_altitude").html(j.altitude)}if(h.debug){console.log("retrieved position",j)}g(".availability_gps_condition_button").each(function(){var o=this;var p=g(o).find(".latitude").html();var q=g(o).find(".longitude").html();var n={latitude:p,longitude:q};var r=h.distance(j,n);if(h.debug){console.log("Update UI Position of ",n," with distance ",r," in span ",o)}e.get_strings([{key:"meters",component:"block_gps"},{key:"kilometers",component:"block_gps"},]).done(function(t){g(o).find(".distanceerror").addClass("hidden");g(o).find(".distanceok").removeClass("hidden");if(r>1000){g(o).find(".distance").html(Math.round(r/1000,1));g(o).find(".distancelabel").html(t[1])}else{g(o).find(".distance").html(r);g(o).find(".distancelabel").html(t[0])}}).fail(d.exception)});var l=false;h.honeypots.forEach(function(n){var p=h.distance(j,n);if(h.debug){console.log("Our distance to honeypot ",n," is ",p)}if(n.accessible&&p<n.accuracy){if(h.debug){console.log("JEHAAA, you reached it!")}l=true;var o=false;h.honeypotshown.forEach(function(q){if(q==n.url){o=true}});if(!o){h.honeypotshown.push(n.url);if(h.debug){console.log("Now showing a success modal!")}if(typeof(h.honeypotmodal)==="undefined"){a.create({type:f.TYPE,}).then(function(q){h.honeypotmodal=q;g(h.honeypotmodal.getRoot()).find('.modal-footer a[data-action="goto"]').attr("href",n.url);g(h.honeypotmodal.getRoot()).find(".modal-body span.name").html('"'+n.name+'"');q.show()})}else{g(h.honeypotmodal.getRoot()).find('.modal-footer a[data-action="goto"]').attr("href",n.url);g(h.honeypotmodal.getRoot()).find(".modal-body span.name").html('"'+n.name+'"');h.honeypotmodal.show()}}else{if(h.debug){console.log("Our last modal was for this honeypot - suppress!")}}}});if(i||l){if(h.debug){console.log("Let us tell Moodle about our new position!")}var k={lat:j.latitude,lon:j.longitude,alt:j.altitude};c.call([{methodname:"block_gps_locate",args:k,done:function(n){if(h.debug){console.log("moodle informed about position",k," replied with",n)}if(n=="coordinates_set"){if(h.debug){console.log("Reloading page")}}},fail:d.exception,}])}var m=h.distance(h.lasttrackedposition,j);if(h.debug){console.log("distance since last tracked position",m)}if(i&&m<5){e.get_strings([{key:"location_not_changed:title",component:"block_gps"},{key:"location_not_changed:body",component:"block_gps"},]).done(function(n){a.create({type:a.types.OK,title:n[0],body:n[1],}).then(function(o){o.show();setTimeout(function(){o.hide()},2000)})}).fail(d.exception)}h.lasttrackedposition=j})}else{alert("geolocation_not_supported")}},pushHoneypot:function(h){if(this.debug){console.log("block_gps/geoassist::pushHoneypot(location)",h)}h.accessible=(typeof(h.visible)!=="undefined"&&h.visible==1);this.honeypots.push(h)},}});